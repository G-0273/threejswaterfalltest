<script>
document.addEventListener("DOMContentLoaded", async () => {
  const mindarThree = new window.MINDAR.IMAGE.MindARThree({
    container: document.querySelector("#container"),
    imageTargetSrc: "./green.mind",
    filterMinCF: 0.1,
    filterBeta: 0.01,
  });

  const { renderer, scene, camera } = mindarThree;
  camera.position.z = 3;

  const anchors = [mindarThree.addAnchor(0), mindarThree.addAnchor(1), mindarThree.addAnchor(2)];
  const gltfLoader = new THREE.GLTFLoader();

  const models = [];
  const mixers = [];
  const persisted = [false, false, false];

  gltfLoader.load("models/waterfall.glb", (gltf) => {
    const animations = gltf.animations;

    anchors.forEach((anchor, index) => {
      const instance = gltf.scene.clone(true);
      instance.scale.set(0.3, 0.3, 0.3);
      instance.rotation.set(0, -Math.PI / 2, 0);
      instance.position.set(0, -1.3, 0);
      anchor.group.add(instance);
      models[index] = instance;

      const mixer = new THREE.AnimationMixer(instance);
      animations.forEach((clip) => {
        const action = mixer.clipAction(clip);
        action.play();
      });
      mixers[index] = mixer;

      anchor.onTargetFound = () => {
        if (!persisted[index]) {
          instance.updateMatrixWorld(true);
          const worldPos = new THREE.Vector3();
          const worldQuat = new THREE.Quaternion();
          const worldScale = new THREE.Vector3();
          instance.matrixWorld.decompose(worldPos, worldQuat, worldScale);

          anchor.group.remove(instance);
          instance.position.copy(worldPos);
          instance.quaternion.copy(worldQuat);
          instance.scale.copy(worldScale);
          scene.add(instance);

          const newMixer = new THREE.AnimationMixer(instance);
          animations.forEach((clip) => {
            const action = newMixer.clipAction(clip);
            action.play();
          });
          mixers[index] = newMixer;

          persisted[index] = true;
        }
      };
    });
  });

  const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
  scene.add(ambientLight);
  const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
  directionalLight.position.set(1, 2, 3);
  scene.add(directionalLight);

  await mindarThree.start();

  const clock = new THREE.Clock();
  renderer.setAnimationLoop(() => {
    const delta = clock.getDelta();
    mixers.forEach((mixer) => {
      if (mixer) mixer.update(delta);
    });
    renderer.render(scene, camera);
  });
});
</script>

